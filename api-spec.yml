openapi: 3.0.3
info:
  title: Credit Simulation API
  description: |
    クレジットシミュレーションAPIは、ローンパラメータを受け取り、
    支払額、手数料、その他の金融計算を実行するRESTful APIです。
    業務IDに基づく2つの異なる計算エンジンを提供します。
    
    - オートクレジット以外 (business_id != "1"): 基本的な分割手数料計算
    - オートクレジット (business_id = "1"): 複利計算による高度な計算
  version: 3.0.0
  contact:
    name: ERC Credit API Support
    url: https://www.erc-credit.net

servers:
  - url: http://52.192.13.133/api
    description: Production server
  - url: https://test2.erc-credit.net/api
    description: Test server
  - url: https://staging.erc-credit.net/api
    description: Staging server
  - url: https://www.erc-credit.net/api
    description: Main production server

security:
  - DomainRestriction: []

paths:
  /simulation:
    post:
      summary: クレジットシミュレーション計算
      description: |
        ローンパラメータを受け取り、支払額、手数料、その他の金融計算結果を返します。
        業務IDに基づいて異なる計算方式を使用します。
      operationId: calculateCreditSimulation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SimulationRequest'
            examples:
              standard_calculation:
                summary: 標準計算例 (business_id != "1")
                value:
                  business_id: "4"
                  product_sum: 100000
                  down_payment_sum: 0
                  real_annual_rate: "3.00"
                  payment_start: "2025/11"
                  payment_number: "3"
                  payment_day: "27"
              advanced_calculation:
                summary: 高度計算例 (business_id = "1")
                value:
                  business_id: "1"
                  product_sum: 100000
                  down_payment_sum: 0
                  real_annual_rate: "10"
                  payment_start: "2025/11"
                  payment_number: "6"
                  payment_day: "27"
                  offer_goods_id: "21"
              bonus_payment:
                summary: ボーナス支払い例
                value:
                  business_id: "4"
                  product_sum: 300000
                  down_payment_sum: 0
                  real_annual_rate: "4.00"
                  payment_start: "2025/01"
                  payment_number: "12"
                  payment_day: "27"
                  bonus_month_summer: "7"
                  bonus_month_winter: "12"
                  bonus_add: "50"
              shop_commission_example:
                summary: 店舗手数料とスキップ料率例
                value:
                  business_id: "4"
                  product_sum: 100000
                  down_payment_sum: 0
                  real_annual_rate: "6.00"
                  skip_rate: "4.20"
                  skip_rate_shop: "0.5"
                  shop_commission_rate: "12.47"
                  payment_start: "2026/05"
                  payment_number: "10"
                  payment_day: "27"
      responses:
        '200':
          description: 計算成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulationSuccessResponse'
              examples:
                standard_response:
                  summary: 標準計算レスポンス例
                  value:
                    success: true
                    data:
                      month_number: ""
                      product_price_balance: 100000
                      shop_commission_rate: ""
                      split_fee: 3000
                      split_payment_sum: 103000
                      payment_sum: 103000
                      bonus_payment_start_month: ""
                      bonus_add_sum: 0
                      bonus_add_number: 0
                      payment: 34300
                      first_payment: 34400
                      payment_period_start: "2025/11/27"
                      payment_period_end: "2026/01/27"
                      shop_commission: ""
                      sales_promotion: ""
                      real_annual_rate: "3.00"
                    request_id: "req_12345"
                    timestamp: "2025-09-30T01:47:29+00:00"
                advanced_response:
                  summary: 高度計算レスポンス例
                  value:
                    success: true
                    data:
                      month_number: ""
                      product_price_balance: 100000
                      shop_commission_rate: ""
                      split_fee: 2940
                      split_payment_sum: 102940
                      payment_sum: 102940
                      bonus_payment_start_month: ""
                      bonus_add_sum: 0
                      bonus_add_number: 0
                      payment: 17100
                      first_payment: 17240
                      payment_period_start: "2025/11/27"
                      payment_period_end: "2026/04/27"
                      shop_commission: ""
                      sales_promotion: ""
                      real_annual_rate: "10"
                    request_id: "req_67890"
                    timestamp: "2025-09-30T02:03:27+00:00"
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation_error:
                  summary: バリデーションエラー例
                  value:
                    success: false
                    error_code: "CS-1002"
                    error_message: "必須パラメータが不足しています"
                    details:
                      missing_parameter: "business_id"
                      request_id: "req_12345"
                      timestamp: "2025-09-30T01:47:29+00:00"
        '403':
          description: アクセス拒否
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                access_denied:
                  summary: アクセス拒否例
                  value:
                    success: false
                    error_code: "CS-9003"
                    error_message: "アクセスが拒否されました"
                    details:
                      host: "unauthorized-domain.com"
                      allowed_domains: ["52.192.13.133", "test2.erc-credit.net", "staging.erc-credit.net", "www.erc-credit.net"]
                      timestamp: "2025-09-30T01:47:29+00:00"
        '404':
          description: エンドポイントが見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                endpoint_not_found:
                  summary: エンドポイントエラー例
                  value:
                    success: false
                    error_code: "CS-9004"
                    error_message: "エンドポイントが見つかりません"
                    details:
                      endpoint: "invalid"
                      valid_endpoints: ["simulation"]
                      timestamp: "2025-09-30T01:47:29+00:00"
        '405':
          description: 許可されていないHTTPメソッド
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                method_not_allowed:
                  summary: メソッドエラー例
                  value:
                    success: false
                    error_code: "CS-9005"
                    error_message: "許可されていないHTTPメソッドです"
                    details:
                      method: "GET"
                      allowed_methods: ["POST"]
                      timestamp: "2025-09-30T01:47:29+00:00"
        '500':
          description: 内部サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                internal_error:
                  summary: 内部エラー例
                  value:
                    success: false
                    error_code: "CS-9001"
                    error_message: "内部サーバーエラーが発生しました"
                    details:
                      request_id: "req_12345"
                      timestamp: "2025-09-30T01:47:29+00:00"

components:
  schemas:
    SimulationRequest:
      type: object
      required:
        - business_id
        - product_sum
        - real_annual_rate
        - payment_start
        - payment_number
        - payment_day
      properties:
        business_id:
          type: string
          description: 業務ID（計算方式を決定）
          pattern: '^[0-9]+$'
          example: "1"
        product_sum:
          type: number
          description: 商品合計金額
          minimum: 1
          example: 100000
        down_payment_sum:
          type: number
          description: 頭金（オプション）
          minimum: 0
          default: 0
          example: 0
        real_annual_rate:
          type: string
          description: 実質年率（business_id="1"の場合は2.8-13.0の範囲制限あり、小数点第二位まで）
          pattern: '^[0-9]+(\.[0-9]{1,2})?$'
          example: "5.5"
        shop_commission_rate:
          type: string
          description: 店手数料率（オプション、小数点第二位まで）
          pattern: '^[0-9]*(\.[0-9]{1,2})?$'
          example: "2.0"
        skip_rate:
          type: string
          description: スキップ料率（オプション、小数点第二位まで）
          pattern: '^[0-9]*(\.[0-9]{1,2})?$'
          example: "1.0"
        skip_rate_shop:
          type: string
          description: スキップ料率の店手数料率（オプション、小数点第二位まで）
          pattern: '^[0-9]*(\.[0-9]{1,2})?$'
          example: "0.5"
        payment_start:
          type: string
          description: 支払い開始月（YYYY/MM形式）
          pattern: '^[0-9]{4}/[0-9]{2}$'
          example: "2025/09"
        payment_number:
          type: number
          description: 支払回数
          minimum: 1
          example: 24
        payment_day:
          type: number
          description: 支払開始日（1-31）
          minimum: 1
          maximum: 31
          example: 27
        bonus_month_summer:
          type: number
          description: ボーナス払い月夏（1-12、オプション）
          minimum: 1
          maximum: 12
          example: 7
        bonus_month_winter:
          type: number
          description: ボーナス払い月冬（1-12、オプション）
          minimum: 1
          maximum: 12
          example: 12
        bonus_add:
          type: number
          description: ボーナス加算額（オプション）(千単位)
          minimum: 0
          example: 50(千単位)
        offer_goods_id:
          type: string
          description: オートクレジット商品ID（business_id="1"の場合必須）
          pattern: '^[0-9]*$'
          example: "21"
        bike_goods_name:
          type: string
          description: オートクレジットバイク商品名（offer_goods_id="23"の場合必須）
          enum:
            - "バイク新車(大型・中型)"
            - "バイク中古車(大型・中型)"
            - "バイク原付等"
          example: "バイク新車(大型・中型)"

    SimulationResponse:
      type: object
      properties:
        month_number:
          type: string
          description: 月番号（空文字列）
          example: ""
        product_price_balance:
          type: number
          description: 商品代金残金
          example: 100000
        shop_commission_rate:
          oneOf:
            - type: number
            - type: string
          description: 店手数料率（0の場合は空文字列）
          example: ""
        split_fee:
          type: number
          description: 分割手数料
          example: 3000
        split_payment_sum:
          type: number
          description: 分割支払金合計
          example: 103000
        payment_sum:
          type: number
          description: お支払総額
          example: 103000
        bonus_payment_start_month:
          type: string
          description: ボーナス支払開始年月
          example: ""
        bonus_add_sum:
          type: number
          description: ボーナス加算額合計
          example: 0
        bonus_add_number:
          type: number
          description: ボーナス加算回数
          example: 0
        payment:
          type: number
          description: 2回目以降支払額
          example: 34300
        first_payment:
          type: number
          description: 初回支払額
          example: 34400
        payment_period_start:
          type: string
          description: 支払開始日
          example: "2025/11/27"
        payment_period_end:
          type: string
          description: 支払終了日
          example: "2026/01/27"
        shop_commission:
          oneOf:
            - type: number
            - type: string
          description: 店手数料（0の場合は空文字列）
          example: ""
        sales_promotion:
          oneOf:
            - type: number
            - type: string
          description: 販売促進費（business_id="1"のみ、0の場合は空文字列）
          example: ""
        real_annual_rate:
          type: string
          description: 実質年率
          example: "3.00"

    SimulationSuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          description: 成功フラグ
          example: true
        data:
          $ref: '#/components/schemas/SimulationResponse'
        request_id:
          type: string
          description: リクエストID
          example: "req_12345"
        timestamp:
          type: string
          format: date-time
          description: レスポンス生成時刻
          example: "2025-09-30T01:47:29+00:00"

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          description: 成功フラグ
          example: false
        error_code:
          type: string
          description: エラーコード
          example: "CS-1002"
        error_message:
          type: string
          description: エラーメッセージ
          example: "必須パラメータが不足しています"
        details:
          type: object
          description: エラー詳細情報
          additionalProperties: true
          example:
            missing_parameter: "business_id"
            request_id: "req_12345"
            timestamp: "2025-09-30T01:47:29+00:00"

  securitySchemes:
    DomainRestriction:
      type: apiKey
      in: header
      name: Host
      description: |
        許可されたドメインからのアクセスのみ受け付けます：
        - 52.192.13.133
        - test2.erc-credit.net
        - staging.erc-credit.net
        - www.erc-credit.net

tags:
  - name: simulation
    description: クレジットシミュレーション計算

externalDocs:
  description: ERC Credit API Documentation
  url: https://www.erc-credit.net/api-docs
